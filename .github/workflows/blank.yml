name: UltimateOS 32-bit Segmented BIN Build

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Clang and binutils
      run: sudo apt update && sudo apt install -y clang binutils

    - name: Create build directory
      run: mkdir -p build

    - name: Compile all .c files to object files
      run: |
        for src in $(find . -name "*.c"); do
          obj="build/$(basename "${src%.c}.o")"
          echo "Compiling $src -> $obj"
          clang -m32 -ffreestanding -O2 -c "$src" -o "$obj"
        done

    - name: Link each .o to 32-bit segmented .bin
      run: |
        for obj in build/*.o; do
          base=$(basename "$obj" .o)
          echo "Linking $obj -> build/$base.bin"
          ld -m elf_i386 -N -e _start --oformat binary "$obj" -o "build/$base.bin" || true
        done

    - name: Upload 32-bit segmented BINs
      uses: actions/upload-artifact@v4
      with:
        name: UltimateOS-32bit-BINs
        path: build/


